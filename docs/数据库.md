- [数据库从OLTP和OLAP到HTAP](#数据库从OLTP和OLAP到HTAP)
- [SQL优化器：RBO与CBO分别是什么](#SQL优化器：RBO与CBO分别是什么)
- [Oracle优化器的RBO和CBO方式](#Oracle优化器的RBO和CBO方式)
- [索引条件下推优化](#索引条件下推优化)
- [SQL优化](#SQL优化)
  -[避免不走索引的场景](#避免不走索引的场景)
  -[SELECT 语句其他优化](#SELECT-语句其他优化)
  -[增删改 DML 语句优化](#增删改-DML-语句优化)
  -[查询条件优化](#查询条件优化)
  -[建表优化](#建表优化)





---------------------------------------------------------------------------------------------------------------------

## 数据库从OLTP和OLAP到HTAP


数据处理大致可以分成两大类：
- 联机事务处理OLTP（on-line transaction processing）
- 联机分析处理OLAP（On-Line Analytical Processing）

从字面上来看OLTP是做事务处理，OLAP是做分析处理。从对数据库操作来看，OLTP主要是对数据的增删改，OLAP是对数据的查询。

OLTP：联机事务处理，实时线上事务处理
OLAP：后台分析，海量数据后台分析

OLTP是传统的关系型数据库的主要应用，主要是基本的、日常的事务处理，例如银行交易。
OLAP是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。

OLTP 系统强调数据库内存效率，强调内存各种指标的命令率，强调绑定变量，强调并发操作；
OLAP 系统则强调数据分析，强调SQL执行市场，强调磁盘I/O，强调分区等。



在互联网浪潮出现之前，企业的数据量普遍不大，特别是核心的业务数据，通常一个单机的数据库就可以保存。那时候的存储并不需要复杂的架构，所有的线上请求 (OLTP, Online Transactional Processing) 和后台分析 (OLAP, Online Analytical Processing) 都跑在同一个数据库实例上。

最近，在数据库行业对HTAP（混合事务/分析处理，Hybrid Transactional/Analytical Processing）这个概念宣传的非常火爆，也衍生出 Real-Time HTAP的说法，主要是因为随着IT行业的发展，很多用户的复杂业务已不再是单纯的OLTP或者OLAP场景，而是二者皆有的混合场景。很多数据库厂商为了响应这样的需求，同时也为了更好的宣传旗下数据库的适用性足够广泛，就纷纷打出可同时支持OLTP和OLAP的混合负载，即支持HTAP的宣传语。




MPP：大规模多级并行处理能力（Massively Parallel Processing，简称MPP）

HTAP：混合事务/分析处理（Hybrid Transactional/Analytical Processing，简称HTAP）

因此，能够统一支持事务处理和工作负载分析的数据库成为众多企业的需求。在此背景下，由 Gartner 提出的 HTAP（混合事务 / 分析处理，Hybrid Transactional/Analytical Processing）成为希望。
基于创新的计算存储框架，HTAP 数据库能够在一份数据上同时支撑业务系统运行和 OLAP 场景，避免在传统架构中，在线与离线数据库之间大量的数据交互。此外，HTAP 基于分布式架构，支持弹性扩容，可按需扩展吞吐或存储，轻松应对高并发、海量数据场景。



[HTAP 会成为数据库的未来吗？](https://www.infoq.cn/article/hjf6phfe7x1h7j4scom8)  
[数据库 OLAP、OLTP的介绍和比较](https://www.huaweicloud.com/articles/7b12de6f47d9b1084129e077e53ca7ff.html)  
[PolarDB-X 2.0 混合事务分析处理（Hybrid Transactional/Analytical Processing，简称HTAP）特性](https://help.aliyun.com/document_detail/184047.html)  
[每周一论文：HTAP](https://zhuanlan.zhihu.com/p/47265992)  
[如何选择适合你的HTAP数据库？](https://www.cnblogs.com/jyzhao/p/14838235.html)  
[Why HTAP Matters](https://pingcap.com/zh/blog/why-htap-matters)  
[]()  





## SQL优化器：RBO与CBO分别是什么


在当今数据库系统领域，查询优化器可以说是必备组件，不管是关系型数据库系统Oracle、MySQL，流处理领域的Flink、Storm，批处理领域的Hive、Spark SQL，还是文本搜索领域的Elasticsearch等，都会内嵌一个查询优化器。

这里拓展一下，关于查询优化器所要解决的核心问题：具有多个连接操作的复杂查询优化。不少学者相继提出了基于左线性树的查询优化算法、基于右线性树的查询优化算法、基于片段式右线性树的查询优化算法、基于浓密树的查询优化算法、基于操作森林的查询优化算法等。这些算法在搜索代价和最终获得的查询计划的效率之间有着不同的权衡。


查询优化器（Query Optimizer）
- RBO: Rule-Based Optimization也即“基于规则的优化器”，该优化器按照硬编码在数据库中的一系列规则来决定SQL的执行计划。
- CBO: Cost-Based Optimization也即“基于代价的优化器”，该优化器通过根据优化规则对关系表达式进行转换，生成多个执行计划，然后CBO会通过根据统计信息(Statistics)和代价模型(Cost Model)计算各种可能“执行计划”的“代价”，即COST，从中选用COST最低的执行方案，作为实际运行方案。

CBO依赖数据库对象的统计信息，统计信息的准确与否会影响CBO做出最优的选择。

以Oracle数据库为例，统计信息包括SQL执行路径的I/O、网络资源、CPU的使用情况。

目前各大数据库和大数据计算引擎都倾向于使用CBO，例如从Oracle 10g开始，Oracle已经彻底放弃RBO，转而使用CBO；而Hive在0.14版本中也引入了CBO。

[SQL优化器-RBO与CBO分别是什么](https://www.cnblogs.com/JasonCeng/p/14199298.html)  
[阿里云分析型数据库AnalyticDB新一代CBO优化器技术](https://developer.aliyun.com/article/751481)  



### Oracle优化器的RBO和CBO方式

Oracle数据库中的优化器又叫查询优化器（Query Optimizer）。
它是SQL分析和执行的优化工具，它负责生成、制定SQL的执行计划。

Oracle的优化器有两种，基于规则的优化器（RBO）与基于代价的优化器（CBO)
- RBO: Rule-Based Optimization 基于规则的优化器
- CBO: Cost-Based Optimization 基于代价的优化器

[ORACLE优化器RBO与CBO介绍总结](https://www.cnblogs.com/kerrycode/p/3842215.html)


---------------------------------------------------------------------------------------------------------------------

### 索引条件下推优化


索引条件下推优化（Index Condition Pushdown (ICP) ）

[什么是索引下推](https://juejin.im/post/6844904017332535304)

索引条件下推优化（Index Condition Pushdown (ICP) ）是MySQL5.6添加的，用于优化数据查询。 

索引条件下推优化可以减少存储引擎查询基础表的次数，也可以减少MySQL服务器从存储引擎接收数据的次数。 


不使用索引条件下推优化时的查询过程:  
获取下一行，首先读取索引信息，然后根据索引将整行数据读取出来。然后通过where条件判断当前数据是否符合条件，符合返回数据。

使用索引条件下推优化时的查询过程:  
获取下一行的索引信息。检查索引中存储的列信息是否符合索引条件，如果符合将整行数据读取出来，如果不符合跳过读取下一行。用剩余的判断条件，判断此行数据是否符合要求，符合要求返回数据。


配置 
索引下推优化是默认开启的。可以通过下面的脚本控制开关

SET optimizer_switch = 'index_condition_pushdown=off';   
SET optimizer_switch = 'index_condition_pushdown=on';  



索引下推优化技术其实就是充分利用了索引中的数据，尽量在查询出整行数据之前过滤掉无效的数据。

由于需要存储引擎将索引中的数据与条件进行判断，所以这个技术是基于存储引擎的，只有特定引擎可以使用。  
并且判断条件需要是在存储引擎这个层面可以进行的操作才可以，比如调用存储过程的条件就不可以，因为存储引擎没有调用存储过程的能力。


---------------------------------------------------------------------------------------------------------------------
## SQL优化


优化成本：硬件>系统配置>数据库表结构>SQL 及索引。  
优化效果：硬件<系统配置<数据库表结构<SQL 及索引。  



对于MySQL层优化我一般遵从五个原则：
- 减少数据访问：设置合理的字段类型，启用压缩，通过索引访问等减少磁盘 IO。
- 返回更少的数据：只返回需要的字段和数据分页处理，减少磁盘 IO 及网络 IO。
- 减少交互次数：批量 DML 操作，函数存储等减少数据连接次数。
- 减少服务器 CPU 开销：尽量减少数据库排序操作以及全表查询，减少 CPU 内存占用。
- 利用更多资源：使用表分区，可以增加并行操作，更大限度利用 CPU 资源。



总结到 SQL 优化中，就如下三点：
- 最大化利用索引
- 尽可能避免全表扫描
- 减少无效数据的查询




### 避免不走索引的场景

- ①尽量避免在字段开头模糊查询，会导致数据库引擎放弃索引进行全表扫描
- ②尽量避免使用 in 和 not in，会导致引擎走全表扫描 
- ③尽量避免使用 or，会导致数据库引擎放弃索引进行全表扫描
- ④尽量避免进行 null 值的判断，会导致数据库引擎放弃索引进行全表扫描
- ⑤尽量避免在 where 条件中等号的左侧进行表达式、函数操作，会导致数据库引擎放弃索引进行全表扫描 
- ⑥当数据量大时，避免使用 where 1=1 的条件
- ⑦查询条件不能用 <> 或者 !=
- ⑧where 条件仅包含复合索引非前置列
- ⑨隐式类型转换造成不使用索引
- ⑩order by 条件要与 where 中条件一致，否则 order by 不会利用索引进行排序
- ⑪正确使用 hint 优化语句



### SELECT 语句其他优化

- ①避免出现 select *
- ②避免出现不确定结果的函数
- ③多表关联查询时，小表在前，大表在后
- ④使用表的别名
- ⑤用 where 字句替换 HAVING 字句
- ⑥调整 Where 字句中的连接顺序



### 增删改 DML 语句优化

- ①大批量插入数据
- ②适当使用 commit
- ③避免重复查询更新的数据
- ④查询优先还是更新（insert、update、delete）优先



### 查询条件优化

- ①对于复杂的查询，可以使用中间临时表暂存数据
- ②优化 group by 语句
-  ③优化 join 语句
- ④优化 union 查询 
-  ⑤拆分复杂 SQL 为多个小 SQL，避免大事务
- ⑥使用 truncate 代替 delete
- ⑦使用合理的分页方式以提高分页效率



### 建表优化
- ①在表中建立索引，优先考虑 where、order by 使用到的字段。
- ②尽量使用数字型字段（如性别，男：1 女：2），若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。
- ③查询数据量大的表 会造成查询缓慢。主要的原因是扫描行数过多。这个时候可以通过程序，分段分页进行查询，循环遍历，将结果合并处理进行展示。
- ④用 varchar/nvarchar 代替 char/nchar。





参考  
[最全面的SQL优化干货总结](https://my.oschina.net/lxw1844912514/blog/4651254)  



---------------------------------------------------------------------------------------------------------------------






MySQL问题

[疑问]你还因为MySQL索引被面试官怼的体无完肤吗？今晚速来
--------------------------------------
[闪电]mysql为什么要存在索引系统
[闪电]mysql索引应该如何设计
[闪电]mysql索引的分类
[闪电]mysql索引的数据结构选择
[闪电]详解mysql的回表和索引覆盖问题
[闪电]详解mysql的最左匹配和索引下推
[闪电]mysql的索引什么时候会失效
[闪电]mysql索引可以有哪些优化点
[闪电]如何优雅的回答mysql索引面试题
----------------------------------------------
[勾引]戳此进直播间啦：https://ke.qq.com/webcourse/index.html?cid=399017&term_id=100475965&taid=9751182080087721&from=41


[得意]高并发下从MySQL到NOSQL的技术选型
-----------------------------------
[玫瑰]mysql的优势与劣势
[玫瑰]NoSQL的意义
[玫瑰]分布式存储特点
[玫瑰]存储层技术选型
---------------------------
[勾引]戳此进直播间啦：https://ke.qq.com/course/399017?taid=9800909211440809&tuin=6c381156



@所有人
[强]史上最全方位透彻讲解mysql
----------------
🔑mysql索引为什么选择B+树
🔑回表、索引覆盖、最左匹配、索引下推
🔑什么是聚簇索引？什么是非聚簇索引
🔑如何利用索引进行优化？
🔑什么情况下回索引失效？
🔑什么是mysql主从复制？
🔑主从复制如何进行搭建？
🔑主从复制延迟问题是什么？
🔑主从复制延迟的产生原因是什么？
🔑如何解决主从复制延迟问题？
🔑你了解MTS吗？
🔑事务的特点
🔑事务的实现机制
🔑什么是MVCC
----------------
👉戳此进直播间：https://ke.qq.com/course/399017?taid=9800909211440809&tuin=6c381156



[礼物]金九银十面试涨薪必备的mysql索引技能
----------------
[强]mysql索引的作用
[强]mysql索引的数据结构
[强]mysql索引的分类
[强]mysql索引相关的面试题
[强]mysql索引的优化点
----------------
[勾引]戳此进直播间啦：https://ke.qq.com/course/399017?taid=10179983024985769&tuin=6c381156




---------------------------------------------------------------------------------------------------------------------








